<p>Metafield value: {{ product.metafields.custom.collection.value }}</p>
{% schema %}
{
  "name": "Related Products",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You may also like"
    },
    {
      "type": "number",
      "id": "limit",
      "label": "Number of products to show",
      "default": 4
    }
  ],
  "presets": [
    {
      "name": "Related Products by Metafield"
    }
  ]
}
{% endschema %}

{% assign current_tag = product.metafields.custom.collection.value %}

{% if current_tag != blank %}
  {% assign related_products = "" | split: "" %}
  {% for p in collections.all.products %}
    {% if p.metafields.custom.collection.value == current_tag and p.id != product.id %}
      {% assign related_products = related_products | push: p %}
    {% endif %}
  {% endfor %}
  {% assign limited_related = related_products | slice: 0, section.settings.limit %}

  {% if limited_related.size > 0 %}
    <!-- related products HTML here -->
  {% else %}
    <p>No related products found for {{ current_tag }}.</p>
  {% endif %}
{% else %}
  <p>This product has no metafield value set.</p>
{% endif %}


<style>
.related-by-metafield {
  padding: 80px 0;
  background: #fff;
}
.related-by-metafield .container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 2rem;
}
.related-by-metafield .heading {
  font-size: 28px;
  font-weight: 500;
  text-align: center;
  margin-bottom: 3rem;
}
.related-by-metafield .related-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 2rem;
}
.related-by-metafield .related-card {
  text-align: center;
  text-decoration: none;
  color: inherit;
}
.related-by-metafield .related-image {
  width: 100%;
  height: auto;
  border-radius: 8px;
  margin-bottom: 1rem;
}
.related-by-metafield .related-title {
  font-size: 16px;
  margin-bottom: 0.25rem;
}
.related-by-metafield .related-price {
  font-size: 15px;
  color: #555;
}
</style>
