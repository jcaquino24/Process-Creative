{% schema %}
{
  "name": "Related Products",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You may also like"
    },
    {
      "type": "number",
      "id": "limit",
      "label": "Number of products to show",
      "default": 4
    }
  ],
  "presets": [
    {
      "name": "Related Products by Metafield"
    }
  ]
}
{% endschema %}

{% assign current_tag = product.metafields.custom.collection.value %}

{% if current_tag != blank %}
  {% assign related_products = "" | split: "" %}

  {% for p in collections.all.products %}
    {% if p.metafields.custom.collection.value == current_tag and p.id != product.id %}
      {% assign related_products = related_products | push: p %}
    {% endif %}
  {% endfor %}

  {% assign limited_related = related_products | slice: 0, section.settings.limit %}

  {% if limited_related.size > 0 %}
  <section class="related-by-metafield">
    <div class="container">
      {% if section.settings.heading != blank %}
        <h2 class="heading">{{ section.settings.heading }}</h2>
      {% endif %}
      <div class="related-grid">
        {% for related in limited_related %}
          <a href="{{ related.url }}" class="related-card">
            {% if related.featured_image %}
              <img 
                src="{{ related.featured_image | image_url: width: 600 }}" 
                alt="{{ related.title }}" 
                class="related-image">
            {% endif %}
            <h3 class="related-title">{{ related.title }}</h3>
            <p class="related-price">{{ related.price | money }}</p>
          </a>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}
{% endif %}

<style>
.related-by-metafield {
  padding: 80px 0;
  background: #fff;
}
.related-by-metafield .container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 2rem;
}
.related-by-metafield .heading {
  font-size: 28px;
  font-weight: 500;
  text-align: center;
  margin-bottom: 3rem;
}
.related-by-metafield .related-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 2rem;
}
.related-by-metafield .related-card {
  text-align: center;
  text-decoration: none;
  color: inherit;
}
.related-by-metafield .related-image {
  width: 100%;
  height: auto;
  border-radius: 8px;
  margin-bottom: 1rem;
}
.related-by-metafield .related-title {
  font-size: 16px;
  margin-bottom: 0.25rem;
}
.related-by-metafield .related-price {
  font-size: 15px;
  color: #555;
}
</style>
